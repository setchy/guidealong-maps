<!DOCTYPE html>
<html>
  <head>
    <title>GuideAlong Tours Map</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
      }
      #controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        max-width: 300px;
      }
      #error {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ff4444;
        color: white;
        padding: 10px;
        border-radius: 8px;
        display: none;
        z-index: 1000;
      }
      .filter-section {
        margin-bottom: 10px;
      }
      select, input {
        width: 100%;
        padding: 5px;
        margin: 5px 0;
      }
      #stats {
        font-size: 12px;
        color: #666;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="loading">Loading tours...</div>
    <div id="error"></div>
    <div id="controls" style="display: none;">
      <h3>GuideAlong Tours</h3>
      <div class="filter-section">
        <label>Filter by country:</label>
        <select id="countryFilter">
          <option value="">All Countries</option>
        </select>
      </div>
      <div class="filter-section">
        <label>Filter by state:</label>
        <select id="stateFilter">
          <option value="">All States</option>
        </select>
      </div>
      <div class="filter-section">
        <label>Search tours:</label>
        <input type="text" id="searchInput" placeholder="Search by name or description">
      </div>
      <div id="stats"></div>
    </div>
    <div id="map" style="height: 100vh"></div>
    <script>
      let map;
      let markers = [];
      let allTours = [];
      let geocoder;

      // Manually curated coordinates for major tour locations
      const knownLocations = {
        'yellowstone': { lat: 44.6, lng: -110.5 },
        'grand canyon': { lat: 36.1, lng: -112.1 },
        'yosemite': { lat: 37.8651, lng: -119.5383 },
        'zion': { lat: 37.2982, lng: -113.0263 },
        'bryce canyon': { lat: 37.5930, lng: -112.1871 },
        'arches': { lat: 38.7331, lng: -109.5925 },
        'canyonlands': { lat: 38.3269, lng: -109.8783 },
        'glacier': { lat: 48.7596, lng: -113.7870 },
        'rocky mountain': { lat: 40.3428, lng: -105.6836 },
        'great smoky mountains': { lat: 35.6118, lng: -83.4895 },
        'acadia': { lat: 44.3386, lng: -68.2733 },
        'banff': { lat: 51.4968, lng: -115.9281 },
        'jasper': { lat: 52.8737, lng: -118.0814 },
        'miami': { lat: 25.7617, lng: -80.1918 },
        'key west': { lat: 24.5551, lng: -81.7800 },
        'blue ridge parkway': { lat: 35.5951, lng: -82.5515 },
        'sedona': { lat: 34.8697, lng: -111.7610 },
        'death valley': { lat: 36.5323, lng: -117.0794 },
        'joshua tree': { lat: 33.8734, lng: -115.9010 },
        'sequoia': { lat: 36.4864, lng: -118.5658 },
        'olympic': { lat: 47.8021, lng: -123.6044 },
        'mount rainier': { lat: 46.8523, lng: -121.7603 },
        'crater lake': { lat: 42.8684, lng: -122.1685 },
        'mesa verde': { lat: 37.1853, lng: -108.4618 },
        'capitol reef': { lat: 38.2876, lng: -111.2479 },
        'big sur': { lat: 36.2704, lng: -121.8081 },
        'lake tahoe': { lat: 39.0968, lng: -120.0324 },
        'natchez trace': { lat: 35.0928, lng: -90.0489 },
        'hawaii': { lat: 19.8968, lng: -155.5828 },
        'maui': { lat: 20.7984, lng: -156.3319 },
        'oahu': { lat: 21.4389, lng: -158.0001 },
        'kauai': { lat: 22.0964, lng: -159.5261 },
        'great ocean road': { lat: -38.6857, lng: 143.1189 },
        'iceland': { lat: 64.9631, lng: -19.0208 },
        'vancouver': { lat: 49.2827, lng: -123.1207 },
        'niagara falls': { lat: 43.0962, lng: -79.0377 }
      };

      
      async function fetchTours() {
        try {
          showLoading('Fetching tour data...');
          // Use corsproxy.io to bypass CORS
          const response = await fetch('https://corsproxy.io/?https://guidealong.com/tour-list/');
          if (!response.ok) throw new Error('Failed to fetch tour data');
          const html = await response.text();
          const tours = parseTourData(html);
          showLoading('Geocoding tour locations...');
          const geocodedTours = await geocodeTours(tours);
          hideLoading(); // Hide loading after geocoding is done
          return geocodedTours;
        } catch (error) {
          console.error('Error fetching tours:', error);
          showError('Unable to fetch live data. Using sample tours.');
          hideLoading(); // Hide loading on error
          return getSampleTours();
        }
      }

      function parseTourData(html) {
        const tours = [];
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Find all tour elements
        const tourElements = doc.querySelectorAll('h3 a[href*="/tour/"]');

        tourElements.forEach(link => {
          const title = link.textContent.trim();
          const url = link.href;
          // Skip if title contains 'bundle' or 'tours' (case-insensitive)
          if (/bundle|tours/i.test(title)) return;

          // Find the parent tour card (assume closest div)
          const parent = link.closest('div') || link.parentElement;

          // Extract description from div.tourmaster-tour-content
          let description = '';
          if (parent) {
            const descDiv = parent.querySelector('div.tourmaster-tour-content');
            if (descDiv) {
              description = descDiv.textContent.trim();
            } else {
              // Fallback: Find all <p> tags and pick the one with the longest text
              const pTags = Array.from(parent.querySelectorAll('p'));
              if (pTags.length) {
                description = pTags.reduce((a, b) => a.textContent.length > b.textContent.length ? a : b).textContent.trim();
              }
            }
          }

          // Extract audio points, duration, tour type
          let audioPoints = '', duration = '', tourType = '';
          if (parent) {
            // Find all <li> or <span> with icons or text
            const textNodes = parent.querySelectorAll('li, span, div');
            textNodes.forEach(node => {
              const txt = node.textContent.trim();
              if (/audio points/i.test(txt)) audioPoints = txt.replace(/audio points[:\s]*/i, '').trim();
              if (/full day|hour|day|1\/2/i.test(txt)) duration = txt;
              if (/tour type/i.test(txt)) tourType = txt.replace(/tour type[:\s]*/i, '').trim();
            });
          }

          // Get image from div.tourmaster-tour-thumbnail
          let image = '';
          if (parent) {
            const thumbDiv = parent.querySelector('div.tourmaster-tour-thumbnail');
            if (thumbDiv) {
              const imgElement = thumbDiv.querySelector('img');
              if (imgElement && imgElement.src) {
                image = imgElement.src;
              }
            } else {
              // Fallback: look for any img in parent
              const imgElement = parent.querySelector('img');
              if (imgElement && imgElement.src) {
                image = imgElement.src;
              }
            }
          }
          tours.push({
            title,
            url,
            description,
            image,
            audioPoints,
            duration,
            tourType,
            lat: null,
            lng: null
          });
        });

        return tours;
      }

      function extractCountryAndStateFromGeocode(geocodeResult) {
        let country = '';
        let state = '';
        if (geocodeResult && geocodeResult.address_components) {
          geocodeResult.address_components.forEach(comp => {
            if (comp.types.includes('country')) country = comp.long_name;
            if (comp.types.includes('administrative_area_level_1')) state = comp.long_name;
          });
        }
        return { country, state };
      }

      async function geocodeTours(tours) {
        const geocodedTours = [];
        
        for (let tour of tours) {
          let coordinates = findKnownLocation(tour.title);
          let geocodeDetails = null;
          if (!coordinates) {
            geocodeDetails = await new Promise((resolve) => {
              let cleanName = tour.title
                .replace(/,.*$/, '') // Remove any comma and following text
                .replace(/\b(tour|audio|driving|walking|guide|app)\b/gi, ' ')
                .replace(/\s*-\s*/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
              geocoder.geocode({ 'address': cleanName }, (results, status) => {
                if (status === 'OK' && results[0]) {
                  resolve(results[0]);
                } else {
                  resolve(null);
                }
              });
            });
            if (geocodeDetails) {
              coordinates = {
                lat: geocodeDetails.geometry.location.lat(),
                lng: geocodeDetails.geometry.location.lng()
              };
            }
          }
          let country = '', state = '';
          if (geocodeDetails) {
            ({ country, state } = extractCountryAndStateFromGeocode(geocodeDetails));
          }
          if (coordinates) {
            geocodedTours.push({
              ...tour,
              lat: coordinates.lat,
              lng: coordinates.lng,
              country,
              state
            });
          }
        }
        
        return geocodedTours;
      }

      function findKnownLocation(title) {
        const titleLower = title.toLowerCase();
        
        for (let location in knownLocations) {
          if (titleLower.includes(location)) {
            return knownLocations[location];
          }
        }
        
        return null;
      }

      function getSampleTours() {
        return [];
      }
      function showLoading(msg) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading').textContent = msg;
      }
      function hideLoading() {
        document.getElementById('loading').style.display = 'none';
      }
      function showError(msg) {
        const errorDiv = document.getElementById('error');
        errorDiv.textContent = msg;
        errorDiv.style.display = 'block';
      }
      function hideError() {
        document.getElementById('error').style.display = 'none';
      }

      function plotToursOnMap(tours) {
        // Remove old markers
        markers.forEach(m => {
          if (m && m.map) m.map = null;
          if (m && m.parentNode) m.parentNode.removeChild(m);
        });
        markers = [];

        let openInfoWindow = null;
        tours.forEach((t) => {
          if (t.lat && t.lng) {
            // Use AdvancedMarkerElement for marker
            const marker = new google.maps.marker.AdvancedMarkerElement({
              map: map,
              position: { lat: t.lat, lng: t.lng },
              title: t.title
            });
            // InfoWindow for marker click
            marker.addListener('click', () => {
              // Close any open InfoWindow
              if (openInfoWindow) {
                openInfoWindow.close();
              }
              const info = new google.maps.InfoWindow({
                content: `<h3>${t.title}</h3>
                  ${t.image ? `<img src='${t.image}' alt='${t.title}' style='max-width:200px;max-height:120px;margin-bottom:8px;border-radius:6px;'>` : ''}
                  ${t.duration ? `<div><b>Duration:</b> ${t.duration}</div>` : ''}
                  ${t.audioPoints ? `<div><b>Audio Points:</b> ${t.audioPoints}</div>` : ''}
                  ${t.tourType ? `<div><b>Tour Type:</b> ${t.tourType}</div>` : ''}
                  ${t.description ? `<p>${t.description}</p>` : '<p>No description available.</p>'}
                  <a href='${t.url}' target='_blank'>Learn more</a>`
              });
              info.open(map, marker);
              openInfoWindow = info;
            });
            markers.push(marker);
          }
        });
      }

      function updateStats(tours) {
        document.getElementById('stats').textContent = `${tours.length} tours shown`;
      }

      function populateFilters(tours) {
        const countrySet = new Set();
        const stateSet = new Set();
        tours.forEach(t => {
          // Add all countries found in geocoded address_components
          if (t.country) countrySet.add(t.country);
          // Add all states found in geocoded address_components
          if (t.state) stateSet.add(t.state);
        });
        const countryFilter = document.getElementById('countryFilter');
        countryFilter.innerHTML = '<option value="">All Countries</option>';
        Array.from(countrySet).sort().forEach(c => {
          if (c) countryFilter.innerHTML += `<option value="${c}">${c}</option>`;
        });
        let stateFilter = document.getElementById('stateFilter');
        if (!stateFilter) {
          // Add state filter to controls if not present
          const stateDiv = document.createElement('div');
          stateDiv.className = 'filter-section';
          stateDiv.innerHTML = `<label for="stateFilter">Filter by state:</label><select id="stateFilter"><option value="">All States</option></select>`;
          document.getElementById('controls').insertBefore(stateDiv, document.getElementById('stats'));
          stateFilter = document.getElementById('stateFilter');
        }
        stateFilter.innerHTML = '<option value="">All States</option>';
        Array.from(stateSet).sort().forEach(s => {
          if (s) stateFilter.innerHTML += `<option value="${s}">${s}</option>`;
        });
      }

      function filterTours() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const country = document.getElementById('countryFilter').value;
        const state = document.getElementById('stateFilter') ? document.getElementById('stateFilter').value : '';
        let filtered = allTours.filter(t => {
          const matchesSearch = t.title.toLowerCase().includes(search) || t.description.toLowerCase().includes(search);
          const matchesCountry = !country || t.country === country;
          const matchesState = !state || t.state === state;
          return matchesSearch && matchesCountry && matchesState;
        });
        plotToursOnMap(filtered);
        updateStats(filtered);
      }

      document.getElementById('searchInput').addEventListener('input', filterTours);
      document.getElementById('countryFilter').addEventListener('change', filterTours);
      // State filter will be added dynamically, so add listener after population

      function initMap() {
        showLoading('Initializing map...');
        hideError();
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 4,
          center: { lat: 39, lng: -98 }, // centered over U.S.
          mapId: "DEMO_MAP_ID" // <-- Replace with your own Map ID for production
        });
        geocoder = new google.maps.Geocoder();

        // Always hide loading after map is initialized
        hideLoading();
        document.getElementById('controls').style.display = 'block';

        fetchTours().then(tours => {
          allTours = tours;
          populateFilters(allTours);
          if (document.getElementById('stateFilter')) {
            document.getElementById('stateFilter').addEventListener('change', filterTours);
          }
          plotToursOnMap(allTours);
          updateStats(allTours);
        }).catch(err => {
          // Fallback in case fetchTours throws
          console.error('Map init error:', err);
          showError('Could not load tours. Showing sample data.');
          allTours = getSampleTours();
          plotToursOnMap(allTours);
          updateStats(allTours);
        });
      }

      // .env loader for browser
      async function loadEnv() {
        try {
          const response = await fetch('.env');
          if (!response.ok) throw new Error('Could not load .env');
          const text = await response.text();
          const lines = text.split('\n');
          const env = {};
          lines.forEach(line => {
            line = line.trim();
            if (line && !line.startsWith('#') && line.includes('=')) {
              const [key, ...rest] = line.split('=');
              env[key.trim()] = rest.join('=').trim();
            }
          });
          return env;
        } catch (e) {
          console.warn('Failed to load .env:', e);
          return {};
        }
      }

      // Use .env loader for Google Maps API key
      (async () => {
        const env = await loadEnv();
        if (env.GOOGLE_MAPS_API_KEY) {
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${env.GOOGLE_MAPS_API_KEY}&libraries=places,marker&callback=initMap`;
          script.async = true;
          script.defer = true;
          document.head.appendChild(script);
        } else {
          showError('Google Maps API key not found in .env');
        }
      })();

      window.initMap = initMap;
    </script>
  </body>
</html>
